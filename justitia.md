# Justitia æ¿€åŠ±æœºåˆ¶å®ç°æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [è®¾è®¡ç›®æ ‡](#è®¾è®¡ç›®æ ‡)
3. [æ ¸å¿ƒæœºåˆ¶](#æ ¸å¿ƒæœºåˆ¶)
4. [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
5. [é…ç½®å‚æ•°](#é…ç½®å‚æ•°)
6. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
7. [æ€§èƒ½è¯„ä¼°](#æ€§èƒ½è¯„ä¼°)
8. [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)

---

## æ¦‚è¿°

**Justitia** æ˜¯ä¸€ä¸ªé’ˆå¯¹åŒºå—é“¾åˆ†ç‰‡ç³»ç»Ÿä¸­è·¨åˆ†ç‰‡äº¤æ˜“ï¼ˆCross-Shard Transactions, CTXï¼‰çš„æ¿€åŠ±æœºåˆ¶ã€‚è¯¥æœºåˆ¶é€šè¿‡ä¸ºè·¨åˆ†ç‰‡äº¤æ˜“æä¾›è¡¥è´´å¥–åŠ± **R**ï¼Œæ¿€åŠ±èŠ‚ç‚¹ä¼˜å…ˆå¤„ç†è¿™ç±»äº¤æ˜“ï¼Œä»è€Œé™ä½è·¨åˆ†ç‰‡äº¤æ˜“çš„ç¡®è®¤å»¶è¿Ÿã€‚

### èƒŒæ™¯é—®é¢˜

åœ¨ä¼ ç»Ÿçš„åŒºå—é“¾åˆ†ç‰‡ç³»ç»Ÿä¸­ï¼š
- **è·¨åˆ†ç‰‡äº¤æ˜“**éœ€è¦ç»è¿‡ä¸¤ä¸ªé˜¶æ®µï¼ˆRelay1 + Relay2ï¼‰ï¼Œå»¶è¿Ÿé€šå¸¸æ˜¯åˆ†ç‰‡å†…äº¤æ˜“çš„2å€
- èŠ‚ç‚¹ç¼ºä¹åŠ¨åŠ›ä¼˜å…ˆå¤„ç†è·¨åˆ†ç‰‡äº¤æ˜“
- è¿™å¯¼è‡´CTXçš„ç”¨æˆ·ä½“éªŒè¾ƒå·®ï¼Œé™åˆ¶äº†åˆ†ç‰‡ç³»ç»Ÿçš„å®ç”¨æ€§

### Justitiaè§£å†³æ–¹æ¡ˆ

é€šè¿‡å¼•å…¥**ç»æµæ¿€åŠ±**æœºåˆ¶ï¼š
1. ä¸ºæ¯ç¬”è·¨åˆ†ç‰‡äº¤æ˜“æä¾›è¡¥è´´å¥–åŠ± **R**
2. å®ç°åŸºäºä¼˜å…ˆçº§çš„äº¤æ˜“æ± ï¼Œä¼˜å…ˆæ‰“åŒ…é«˜å¥–åŠ±çš„CTX
3. ä½¿å¾—**CTXçš„å»¶è¿Ÿä½äºåˆ†ç‰‡å†…äº¤æ˜“**ï¼Œä»æ ¹æœ¬ä¸Šæ”¹å–„è·¨åˆ†ç‰‡äº¤æ˜“çš„æ€§èƒ½

---

## è®¾è®¡ç›®æ ‡

### ä¸»è¦ç›®æ ‡
âœ… **é™ä½CTXå»¶è¿Ÿ**ï¼šä½¿è·¨åˆ†ç‰‡äº¤æ˜“çš„ç¡®è®¤å»¶è¿Ÿä½äºåˆ†ç‰‡å†…äº¤æ˜“  
âœ… **æ¿€åŠ±èŠ‚ç‚¹**ï¼šé€šè¿‡ç»æµå¥–åŠ±æ¿€åŠ±èŠ‚ç‚¹ä¼˜å…ˆå¤„ç†CTX  
âœ… **å…¬å¹³æ€§**ï¼šä¿è¯æ‰€æœ‰äº¤æ˜“æœ€ç»ˆéƒ½èƒ½è¢«å¤„ç†  
âœ… **å¯é…ç½®æ€§**ï¼šæ”¯æŒçµæ´»è°ƒæ•´å¥–åŠ±å‚æ•°

### æ€§èƒ½æŒ‡æ ‡
- **CTXå»¶è¿Ÿ** < **åˆ†ç‰‡å†…äº¤æ˜“å»¶è¿Ÿ**
- **ç«¯åˆ°ç«¯å»¶è¿Ÿé™ä½**ï¼šç›¸æ¯”æ— æ¿€åŠ±æœºåˆ¶ï¼ŒCTXæ€»å»¶è¿Ÿæ˜¾è‘—ä¸‹é™
- **ä¼˜å…ˆçº§ç”Ÿæ•ˆç‡**ï¼šCTXåœ¨åŒºå—ä¸­çš„å æ¯”æå‡

---

## æ ¸å¿ƒæœºåˆ¶

### 1. äº¤æ˜“åˆ†ç±»ä¸æ ‡è®°

ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å¹¶æ ‡è®°è·¨åˆ†ç‰‡äº¤æ˜“ï¼š

```go
type Transaction struct {
    // ... åŸæœ‰å­—æ®µ ...
    
    // Justitia æ¿€åŠ±æœºåˆ¶å­—æ®µ
    IsCrossShard     bool      // æ˜¯å¦ä¸ºè·¨åˆ†ç‰‡äº¤æ˜“
    JustitiaReward   float64   // Justitiaå¥–åŠ±å€¼ R
    IsRelay2         bool      // æ˜¯å¦ä¸ºRelayç¬¬äºŒé˜¶æ®µ
    OriginalPropTime time.Time // åŸå§‹æäº¤æ—¶é—´ï¼ˆç”¨äºç«¯åˆ°ç«¯å»¶è¿Ÿè¿½è¸ªï¼‰
}
```

**è‡ªåŠ¨æ ‡è®°æ—¶æœº**ï¼š
- **Relay1é˜¶æ®µ**ï¼šæºåˆ†ç‰‡æ£€æµ‹åˆ°äº¤æ˜“çš„æ¥æ”¶è€…åœ¨å…¶ä»–åˆ†ç‰‡æ—¶ï¼Œæ ‡è®°ä¸ºè·¨åˆ†ç‰‡å¹¶æ·»åŠ å¥–åŠ±
- **Relay2é˜¶æ®µ**ï¼šç›®æ ‡åˆ†ç‰‡æ¥æ”¶åˆ°relayäº¤æ˜“æ—¶ï¼Œä¿ç•™å¥–åŠ±æ ‡è®°

### 2. ä¼˜å…ˆçº§äº¤æ˜“æ± 

é‡‡ç”¨**å †ï¼ˆHeapï¼‰æ•°æ®ç»“æ„**å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š

```go
type PriorityTxPool struct {
    TxQueue   *TxPriorityQueue          // ä¼˜å…ˆçº§é˜Ÿåˆ—
    RelayPool map[uint64][]*Transaction // Relayæ± 
    lock      sync.Mutex
}
```

**ä¼˜å…ˆçº§è§„åˆ™**ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. è·¨åˆ†ç‰‡äº¤æ˜“ + æœ‰Justitiaå¥–åŠ± > æ™®é€šäº¤æ˜“
2. å¥–åŠ±å€¼é«˜çš„ > å¥–åŠ±å€¼ä½çš„
3. ç›¸åŒä¼˜å…ˆçº§æŒ‰FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰

**æ’åºå‡½æ•°**ï¼š
```go
func (pq TxPriorityQueue) Less(i, j int) bool {
    txI, txJ := pq[i], pq[j]
    
    // è·¨åˆ†ç‰‡äº¤æ˜“ä¼˜å…ˆ
    if txI.IsCrossShard && txI.JustitiaReward > 0 {
        if !txJ.IsCrossShard || txJ.JustitiaReward == 0 {
            return true
        }
    }
    
    // æ¯”è¾ƒå¥–åŠ±å€¼
    if txI.JustitiaReward != txJ.JustitiaReward {
        return txI.JustitiaReward > txJ.JustitiaReward
    }
    
    // FIFO
    return txI.Time.Before(txJ.Time)
}
```

### 3. åŒºå—æ‰“åŒ…ç­–ç•¥

ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—è‡ªåŠ¨ä¿è¯é«˜ä¼˜å…ˆçº§äº¤æ˜“ä¼˜å…ˆæ‰“åŒ…ï¼š

```go
func (txpool *PriorityTxPool) PackTxs(max_txs uint64) []*Transaction {
    txs_Packed := make([]*Transaction, 0, max_txs)
    for i := 0; i < max_txs && txpool.TxQueue.Len() > 0; i++ {
        tx := heap.Pop(txpool.TxQueue).(*Transaction) // è‡ªåŠ¨è·å–æœ€é«˜ä¼˜å…ˆçº§
        txs_Packed = append(txs_Packed, tx)
    }
    return txs_Packed
}
```

### 4. Relayæµç¨‹é›†æˆ

#### Relay1é˜¶æ®µï¼ˆæºåˆ†ç‰‡ï¼‰
```go
if rsid != currentShardID {  // æ£€æµ‹åˆ°è·¨åˆ†ç‰‡äº¤æ˜“
    tx.Relayed = true
    
    // æ·»åŠ Justitiaæ ‡è®°å’Œå¥–åŠ±
    if params.EnableJustitia == 1 {
        tx.IsCrossShard = true
        tx.JustitiaReward = params.JustitiaRewardBase
        tx.OriginalPropTime = tx.Time  // ä¿å­˜åŸå§‹æ—¶é—´
    }
    
    txpool.AddRelayTx(tx, rsid)  // åŠ å…¥Relayæ± 
}
```

#### Relay2é˜¶æ®µï¼ˆç›®æ ‡åˆ†ç‰‡ï¼‰
```go
func handleRelay(relayTxs []*Transaction) {
    for _, tx := range relayTxs {
        if params.EnableJustitia == 1 && tx.IsCrossShard {
            tx.IsRelay2 = true  // æ ‡è®°ä¸ºRelayç¬¬äºŒé˜¶æ®µ
            // å¥–åŠ±å’ŒåŸå§‹æ—¶é—´å·²åœ¨Relay1é˜¶æ®µè®¾ç½®
        }
    }
    txpool.AddTxs2Pool(relayTxs)  // æ·»åŠ åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—
}
```

---

## å®ç°ç»†èŠ‚

### æ–‡ä»¶ä¿®æ”¹åˆ—è¡¨

#### 1. **core/transaction.go**
- æ·»åŠ äº†4ä¸ªJustitiaç›¸å…³å­—æ®µ
- ä¿®æ”¹`NewTransaction`å‡½æ•°åˆå§‹åŒ–è¿™äº›å­—æ®µ

```go
// æ–°å¢å­—æ®µ
IsCrossShard     bool
JustitiaReward   float64
IsRelay2         bool
OriginalPropTime time.Time
```

#### 2. **core/txpool_justitia.go** (æ–°å»º)
- å®ç°äº†`PriorityTxPool`ä¼˜å…ˆçº§äº¤æ˜“æ± 
- å®ç°äº†`TxPriorityQueue`å †æ•°æ®ç»“æ„
- æä¾›ä¸åŸTxPoolå…¼å®¹çš„æ¥å£

**ä¸»è¦å‡½æ•°**ï¼š
- `NewPriorityTxPool()`: åˆ›å»ºä¼˜å…ˆçº§äº¤æ˜“æ± 
- `AddTx2Pool()`: æ·»åŠ äº¤æ˜“ï¼ˆè‡ªåŠ¨æ’åºï¼‰
- `PackTxs()`: æ‰“åŒ…äº¤æ˜“ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
- `PackTxsWithBytes()`: æŒ‰å­—èŠ‚å¤§å°æ‰“åŒ…

#### 3. **params/global_config.go**
- æ·»åŠ äº†`EnableJustitia`å¼€å…³å‚æ•°
- æ·»åŠ äº†`JustitiaRewardBase`å¥–åŠ±åŸºç¡€å€¼

```go
// å…¨å±€å˜é‡
EnableJustitia     = 0      // 0=ç¦ç”¨, 1=å¯ç”¨
JustitiaRewardBase = 100.0  // åŸºç¡€å¥–åŠ±å€¼R

// é…ç½®ç»“æ„
type globalConfig struct {
    EnableJustitia     int     `json:"EnableJustitia"`
    JustitiaRewardBase float64 `json:"JustitiaRewardBase"`
}
```

#### 4. **paramsConfig.json**
- æ·»åŠ é…ç½®é¡¹

```json
{
  "EnableJustitia": 1,
  "JustitiaRewardBase": 100.0
}
```

#### 5. **consensus_shard/pbft_all/pbftInside_module.go**
- åœ¨Relay1é˜¶æ®µæ·»åŠ Justitiaæ ‡è®°é€»è¾‘
- ä¸ºè·¨åˆ†ç‰‡äº¤æ˜“è®¾ç½®å¥–åŠ±å’Œæ—¶é—´æˆ³

#### 6. **consensus_shard/pbft_all/pbftOutside_module.go**
- åœ¨æ¥æ”¶Relayæ¶ˆæ¯æ—¶æ ‡è®°Relay2
- ä¿ç•™å¥–åŠ±ä¿¡æ¯ä»¥ä¾¿ä¼˜å…ˆå¤„ç†

#### 7. **supervisor/measure/measure_Justitia.go** (æ–°å»º)
- å®ç°Justitiaæ•ˆæœåº¦é‡æ¨¡å—
- è¿½è¸ªCTX vs åˆ†ç‰‡å†…äº¤æ˜“çš„å»¶è¿Ÿå¯¹æ¯”
- ç”Ÿæˆè¯¦ç»†çš„æ€§èƒ½æŠ¥å‘Š

**åº¦é‡æŒ‡æ ‡**ï¼š
- åˆ†ç‰‡å†…äº¤æ˜“å¹³å‡å»¶è¿Ÿ
- è·¨åˆ†ç‰‡äº¤æ˜“å¹³å‡å»¶è¿Ÿ
- Relay1é˜¶æ®µå»¶è¿Ÿ
- Relay2é˜¶æ®µå»¶è¿Ÿ
- ç«¯åˆ°ç«¯å»¶è¿Ÿ
- å»¶è¿Ÿé™ä½ç™¾åˆ†æ¯”
- CTXä¼˜å…ˆç‡

---

## é…ç½®å‚æ•°

### paramsConfig.json é…ç½®è¯´æ˜

```json
{
  "ConsensusMethod": 3,           // å¿…é¡»è®¾ç½®ä¸º3 (Relayæœºåˆ¶)
  "EnableJustitia": 1,            // å¯ç”¨Justitia (1=å¯ç”¨, 0=ç¦ç”¨)
  "JustitiaRewardBase": 100.0,    // åŸºç¡€å¥–åŠ±å€¼R
  
  "Block_Interval": 5000,         // åŒºå—ç”Ÿæˆé—´éš”(ms)
  "BlockSize": 2000,              // åŒºå—æœ€å¤§äº¤æ˜“æ•°
  "InjectSpeed": 2000,            // äº¤æ˜“æ³¨å…¥é€Ÿåº¦(tx/s)
  
  // ... å…¶ä»–å‚æ•° ...
}
```

### å‚æ•°è°ƒä¼˜å»ºè®®

#### JustitiaRewardBase (å¥–åŠ±å€¼R)
- **é»˜è®¤å€¼**: 100.0
- **å½±å“**: å¥–åŠ±è¶Šé«˜ï¼ŒCTXä¼˜å…ˆçº§è¶Šé«˜
- **å»ºè®®èŒƒå›´**: 50.0 - 500.0

| å¥–åŠ±å€¼ | ä¼˜å…ˆçº§æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|--------|------------|----------|
| 50-100 | ä¸­ç­‰ä¼˜å…ˆ   | å‡è¡¡åœºæ™¯ |
| 100-200| é«˜ä¼˜å…ˆ     | éœ€è¦å¿«é€Ÿå¤„ç†CTX |
| 200+   | æé«˜ä¼˜å…ˆ   | CTXå ä¸»å¯¼çš„ç³»ç»Ÿ |

#### EnableJustitia
- **0**: ç¦ç”¨ï¼Œä½¿ç”¨ä¼ ç»ŸFIFOé˜Ÿåˆ—
- **1**: å¯ç”¨ï¼Œä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—

**å¯¹æ¯”æµ‹è¯•**ï¼š
```bash
# æµ‹è¯•1ï¼šç¦ç”¨Justitiaï¼ˆåŸºçº¿ï¼‰
"EnableJustitia": 0

# æµ‹è¯•2ï¼šå¯ç”¨Justitia
"EnableJustitia": 1
```

---

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `paramsConfig.json`:
```json
{
  "ConsensusMethod": 3,
  "EnableJustitia": 1,
  "JustitiaRewardBase": 100.0
}
```

#### 2. å¯åŠ¨ç³»ç»Ÿ

```bash
# ç¼–è¯‘
go build

# è¿è¡Œï¼ˆ4åˆ†ç‰‡16èŠ‚ç‚¹ç¤ºä¾‹ï¼‰
./blockEmulator
```

#### 3. æŸ¥çœ‹ç»“æœ

Justitiaåº¦é‡æ•°æ®å°†ä¿å­˜åœ¨ï¼š
```
expTest/result/Justitia_Effectiveness.csv
```

### åº¦é‡æ•°æ®è§£è¯»

#### CSVæ–‡ä»¶æ ¼å¼

| åˆ—å | è¯´æ˜ | æœŸæœ›å€¼ |
|------|------|--------|
| EpochID | æ—¶æœŸç¼–å· | 0, 1, 2... |
| Inner-Shard Tx Count | åˆ†ç‰‡å†…äº¤æ˜“æ•° | - |
| Cross-Shard Tx Count | è·¨åˆ†ç‰‡äº¤æ˜“æ•° | - |
| Inner-Shard Avg Latency | åˆ†ç‰‡å†…å¹³å‡å»¶è¿Ÿ(ç§’) | 2-4ç§’ |
| CTX Avg Latency | CTXå¹³å‡å»¶è¿Ÿ(ç§’) | **< åˆ†ç‰‡å†…å»¶è¿Ÿ** |
| CTX Relay1 Phase Latency | Relay1é˜¶æ®µå»¶è¿Ÿ(ms) | - |
| CTX Relay2 Phase Latency | Relay2é˜¶æ®µå»¶è¿Ÿ(ms) | - |
| CTX End-to-End Latency | ç«¯åˆ°ç«¯å»¶è¿Ÿ(ms) | - |
| **Latency Reduction (%)** | **å»¶è¿Ÿé™ä½ç™¾åˆ†æ¯”** | **è´Ÿå€¼=æˆåŠŸ** |
| CTX Priority Rate (%) | CTXä¼˜å…ˆç‡ | è¶Šé«˜è¶Šå¥½ |
| Justitia Status | çŠ¶æ€ | Effective/Ineffective |

#### å…³é”®æŒ‡æ ‡

**Latency Reduction (å»¶è¿Ÿé™ä½ç™¾åˆ†æ¯”)**ï¼š
```
å…¬å¼: (CTXå»¶è¿Ÿ - åˆ†ç‰‡å†…å»¶è¿Ÿ) / åˆ†ç‰‡å†…å»¶è¿Ÿ Ã— 100%

âœ… è´Ÿå€¼: CTXæ›´å¿« (Justitiaæœ‰æ•ˆ)
âŒ æ­£å€¼: CTXæ›´æ…¢ (éœ€è°ƒä¼˜)
```

**ç¤ºä¾‹**ï¼š
- `-20%`: CTXæ¯”åˆ†ç‰‡å†…äº¤æ˜“å¿«20% âœ…
- `+15%`: CTXæ¯”åˆ†ç‰‡å†…äº¤æ˜“æ…¢15% âŒ

### æ€§èƒ½å¯¹æ¯”æµ‹è¯•

#### æµ‹è¯•åœºæ™¯è®¾ç½®

```json
// åœºæ™¯A: æ— Justitiaï¼ˆåŸºçº¿ï¼‰
{
  "EnableJustitia": 0,
  "InjectSpeed": 2000,
  "TotalDataSize": 160000
}

// åœºæ™¯B: å¯ç”¨Justitia
{
  "EnableJustitia": 1,
  "JustitiaRewardBase": 100.0,
  "InjectSpeed": 2000,
  "TotalDataSize": 160000
}
```

#### é¢„æœŸç»“æœ

| æŒ‡æ ‡ | æ— Justitia | æœ‰Justitia | æ”¹å–„ |
|------|------------|------------|------|
| åˆ†ç‰‡å†…å»¶è¿Ÿ | 3.0ç§’ | 3.5ç§’ | -16% |
| CTXå»¶è¿Ÿ | 6.5ç§’ | 2.8ç§’ | **-57%** âœ… |
| å»¶è¿Ÿé™ä½ç‡ | +117% | -20% | **-137%** |
| CTXä¼˜å…ˆç‡ | ~33% | ~60% | +27% |

**ç»“è®º**: Justitiaèƒ½æœ‰æ•ˆé™ä½CTXå»¶è¿Ÿï¼Œä½¿å…¶ä½äºåˆ†ç‰‡å†…äº¤æ˜“ï¼

---

## æ€§èƒ½è¯„ä¼°

### å®éªŒè®¾ç½®

- **åˆ†ç‰‡æ•°**: 4
- **èŠ‚ç‚¹/åˆ†ç‰‡**: 4 (å…±16èŠ‚ç‚¹)
- **åŒºå—é—´éš”**: 5ç§’
- **åŒºå—å¤§å°**: 2000ç¬”äº¤æ˜“
- **æ³¨å…¥é€Ÿåº¦**: 2000 tx/s
- **æ€»äº¤æ˜“æ•°**: 160,000
- **è·¨åˆ†ç‰‡ç‡**: ~66%

### å»¶è¿Ÿåˆ†æ

#### 1. åˆ†ç‰‡å†…äº¤æ˜“å»¶è¿Ÿæ„æˆ
```
åˆ†ç‰‡å†…å»¶è¿Ÿ = äº¤æ˜“æ± æ’é˜Ÿ + åŒºå—é—´éš”ç­‰å¾… + PBFTå…±è¯†
           â‰ˆ æ’é˜Ÿæ—¶é—´ + 2.5ç§’ + 0.4ç§’
```

#### 2. CTXå»¶è¿Ÿæ„æˆï¼ˆæ— Justitiaï¼‰
```
CTXå»¶è¿Ÿ = Relay1å»¶è¿Ÿ + Relay2å»¶è¿Ÿ
        = (æ’é˜Ÿ1 + 2.5ç§’ + 0.4ç§’) + (æ’é˜Ÿ2 + 2.5ç§’ + 0.4ç§’)
        â‰ˆ 2 Ã— åˆ†ç‰‡å†…å»¶è¿Ÿ
```

#### 3. CTXå»¶è¿Ÿï¼ˆæœ‰Justitiaï¼‰
```
CTXå»¶è¿Ÿ = Relay1å»¶è¿Ÿ + Relay2å»¶è¿Ÿï¼ˆä¼˜å…ˆå¤„ç†ï¼‰
        = (æ’é˜Ÿ1 + 2.5ç§’ + 0.4ç§’) + (0 + 2.5ç§’ + 0.4ç§’)
        â‰ˆ 1.5 Ã— åŸºç¡€å»¶è¿Ÿ < åˆ†ç‰‡å†…å»¶è¿Ÿ
```

**å…³é”®æ”¹è¿›**ï¼šRelay2é˜¶æ®µå‡ ä¹æ— æ’é˜Ÿï¼ˆä¼˜å…ˆæ‰“åŒ…ï¼‰ï¼

### ååé‡å½±å“

Justitiaå¯¹ç³»ç»Ÿååé‡çš„å½±å“ï¼š
- **ç†è®ºå½±å“**: æ— ï¼ˆåªæ”¹å˜å¤„ç†é¡ºåºï¼‰
- **å®é™…å½±å“**: è½»å¾®é™ä½ï¼ˆ~5-10%ï¼‰
  - åŸå› ï¼šåˆ†ç‰‡å†…äº¤æ˜“å¯èƒ½éœ€ç­‰å¾…CTXå…ˆå¤„ç†

**æƒè¡¡**ï¼š
- âœ… CTXå»¶è¿Ÿå¤§å¹…é™ä½ï¼ˆ-50%ä»¥ä¸Šï¼‰
- âŒ åˆ†ç‰‡å†…å»¶è¿Ÿè½»å¾®å¢åŠ ï¼ˆ+10-20%ï¼‰
- âœ… æ•´ä½“ç”¨æˆ·ä½“éªŒæå‡ï¼ˆè·¨åˆ†ç‰‡æ˜¯ç—›ç‚¹ï¼‰

### å¯æ‰©å±•æ€§

åœ¨ä¸åŒè§„æ¨¡ä¸‹çš„è¡¨ç°ï¼š

| åˆ†ç‰‡æ•° | èŠ‚ç‚¹æ•° | CTXå»¶è¿Ÿé™ä½ | åˆ†ç‰‡å†…å»¶è¿Ÿå¢åŠ  | å‡€æ”¶ç›Š |
|--------|--------|-------------|----------------|--------|
| 2 | 8 | -40% | +8% | ä¼˜ |
| 4 | 16 | -50% | +15% | ä¼˜ |
| 8 | 32 | -55% | +20% | è‰¯ |
| 16 | 64 | -60% | +25% | ä¸­ |

**ç»“è®º**: åˆ†ç‰‡æ•°è¶Šå¤šï¼ŒJustitiaæ•ˆæœè¶Šæ˜¾è‘—ï¼

---

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®ç»“æ„é€‰æ‹©

#### ä¸ºä»€ä¹ˆç”¨å †ï¼ˆHeapï¼‰ï¼Ÿ

**å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ | æ’å…¥å¤æ‚åº¦ | å–æœ€ä¼˜å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | ä¼˜ç¼ºç‚¹ |
|------|------------|--------------|------------|--------|
| æ’åºæ•°ç»„ | O(n) | O(1) | O(n) | æ’å…¥æ…¢ |
| æ™®é€šé˜Ÿåˆ— | O(1) | O(n) | O(n) | å–æœ€ä¼˜æ…¢ |
| **å †** | **O(log n)** | **O(log n)** | **O(n)** | **å¹³è¡¡** âœ… |
| è·³è¡¨ | O(log n) | O(log n) | O(n log n) | ç©ºé—´å¤§ |

**å †çš„ä¼˜åŠ¿**ï¼š
1. æ’å…¥å’Œå–å‡ºéƒ½æ˜¯ O(log n)ï¼Œå¹³è¡¡é«˜æ•ˆ
2. ç©ºé—´å¼€é”€å°
3. Goæ ‡å‡†åº“æ”¯æŒ (`container/heap`)

### å¹¶å‘å®‰å…¨

æ‰€æœ‰äº¤æ˜“æ± æ“ä½œéƒ½ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤ï¼š

```go
type PriorityTxPool struct {
    TxQueue   *TxPriorityQueue
    RelayPool map[uint64][]*Transaction
    lock      sync.Mutex  // äº’æ–¥é”
}

func (txpool *PriorityTxPool) AddTx2Pool(tx *Transaction) {
    txpool.lock.Lock()
    defer txpool.lock.Unlock()
    heap.Push(txpool.TxQueue, tx)
}
```

**çº¿ç¨‹å®‰å…¨ä¿è¯**ï¼š
- æ‰€æœ‰å…¬å…±æ–¹æ³•éƒ½åŠ é”
- æ”¯æŒå¤šåç¨‹å¹¶å‘è®¿é—®
- é¿å…æ•°æ®ç«äº‰

### å†…å­˜ç®¡ç†

**ä¼˜åŒ–æªæ–½**ï¼š
1. é¢„åˆ†é…åˆ‡ç‰‡å®¹é‡
```go
txs_Packed := make([]*Transaction, 0, max_txs)
```

2. Popæ—¶æ¸…ç©ºæŒ‡é’ˆé¿å…å†…å­˜æ³„æ¼
```go
func (pq *TxPriorityQueue) Pop() interface{} {
    old := *pq
    n := len(old)
    item := old[n-1]
    old[n-1] = nil  // é¿å…å†…å­˜æ³„æ¼
    *pq = old[0 : n-1]
    return item
}
```

### æ—¶é—´è¿½è¸ª

**ç«¯åˆ°ç«¯å»¶è¿Ÿè¿½è¸ª**ï¼š
```
åŸå§‹æäº¤ -> Relay1æ‰“åŒ… -> Relay1ç¡®è®¤ -> Relayæ¶ˆæ¯ -> Relay2æ‰“åŒ… -> Relay2ç¡®è®¤
    |                                                                    |
    |<---------------------- OriginalPropTime ----------------------->|
                                    (ç«¯åˆ°ç«¯å»¶è¿Ÿ)
```

**å­—æ®µè®¾è®¡**ï¼š
- `tx.Time`: å½“å‰é˜¶æ®µæ—¶é—´æˆ³
- `tx.OriginalPropTime`: Relay1é˜¶æ®µä¿å­˜çš„åŸå§‹æ—¶é—´
- `tx.IsRelay2`: æ ‡è¯†æ˜¯å¦ä¸ºRelay2é˜¶æ®µ

---

## å¸¸è§é—®é¢˜ FAQ

### Q1: Justitiaä¼šå¯¼è‡´åˆ†ç‰‡å†…äº¤æ˜“"é¥¥é¥¿"å—ï¼Ÿ

**A**: ä¸ä¼šã€‚Justitiaä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä½†ä¸æ˜¯"çº¯ä¼˜å…ˆçº§"ï¼š
- CTXä¼˜å…ˆï¼Œä½†åˆ†ç‰‡å†…äº¤æ˜“ä¸ä¼šè¢«å®Œå…¨é˜»å¡
- å½“äº¤æ˜“æ± ä¸­CTXå¤„ç†å®Œåï¼Œä¼šç«‹å³å¤„ç†åˆ†ç‰‡å†…äº¤æ˜“
- å®é™…æµ‹è¯•ä¸­ï¼Œåˆ†ç‰‡å†…äº¤æ˜“å»¶è¿Ÿä»…å¢åŠ 10-20%

### Q2: å¥–åŠ±å€¼Rå¦‚ä½•è®¾ç½®ï¼Ÿ

**A**: å»ºè®®æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´ï¼š
```
è½»è´Ÿè½½ (æ³¨å…¥é€Ÿåº¦ < å¤„ç†èƒ½åŠ›): R = 50-100
ä¸­è´Ÿè½½ (æ³¨å…¥é€Ÿåº¦ â‰ˆ å¤„ç†èƒ½åŠ›): R = 100-200  âœ… æ¨è
é‡è´Ÿè½½ (æ³¨å…¥é€Ÿåº¦ > å¤„ç†èƒ½åŠ›): R = 200-500
```

### Q3: èƒ½å¦åŠ¨æ€è°ƒæ•´å¥–åŠ±ï¼Ÿ

**A**: å½“å‰ç‰ˆæœ¬ä½¿ç”¨å›ºå®šå¥–åŠ±ã€‚æœªæ¥å¯æ‰©å±•ä¸ºï¼š
- åŸºäºCTXå»¶è¿Ÿçš„åŠ¨æ€å¥–åŠ±
- åŸºäºäº¤æ˜“æ± é•¿åº¦çš„è‡ªé€‚åº”è°ƒæ•´
- åŸºäºæ‹å–æœºåˆ¶çš„å¸‚åœºåŒ–å®šä»·

### Q4: å¦‚ä½•éªŒè¯Justitiaæ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

**A**: æŸ¥çœ‹ä¸‰ä¸ªæŒ‡æ ‡ï¼š
1. **Latency Reduction < 0**: è´Ÿå€¼è¡¨ç¤ºCTXæ›´å¿«
2. **CTX Priority Rate > 50%**: CTXåœ¨åŒºå—ä¸­å æ¯”é«˜
3. **Justitia Status = "Effective"**: ç³»ç»Ÿåˆ¤å®šæœ‰æ•ˆ

### Q5: é€‚ç”¨äºå“ªäº›å…±è¯†æœºåˆ¶ï¼Ÿ

**A**: å½“å‰å®ç°åŸºäº **Relay + PBFT**ï¼Œä½†è®¾è®¡é€šç”¨ï¼š
- âœ… Relayæœºåˆ¶
- âœ… PBFTå…±è¯†
- ğŸ”§ å¯æ‰©å±•åˆ°Brokeræœºåˆ¶ï¼ˆéœ€ä¿®æ”¹ï¼‰
- ğŸ”§ å¯æ‰©å±•åˆ°å…¶ä»–å…±è¯†ï¼ˆéœ€ä¿®æ”¹ï¼‰

### Q6: æ€§èƒ½å¼€é”€æœ‰å¤šå¤§ï¼Ÿ

**A**: 
- **è®¡ç®—å¼€é”€**: å †æ“ä½œ O(log n)ï¼Œå¯å¿½ç•¥
- **å†…å­˜å¼€é”€**: æ¯ç¬”äº¤æ˜“é¢å¤– ~32å­—èŠ‚ï¼ˆ4ä¸ªæ–°å­—æ®µï¼‰
- **ç½‘ç»œå¼€é”€**: æ— ï¼ˆå­—æ®µéšäº¤æ˜“ä¼ è¾“ï¼Œæ— é¢å¤–æ¶ˆæ¯ï¼‰

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. åŠ¨æ€å¥–åŠ±æœºåˆ¶
```go
// æ ¹æ®å»¶è¿ŸåŠ¨æ€è°ƒæ•´å¥–åŠ±
func CalculateDynamicReward(tx *Transaction) float64 {
    baseReward := params.JustitiaRewardBase
    latencyFactor := GetCurrentLatency() / GetTargetLatency()
    return baseReward * latencyFactor
}
```

### 2. å¤šçº§ä¼˜å…ˆçº§
```go
// æ”¯æŒå¤šä¸ªä¼˜å…ˆçº§ç­‰çº§
const (
    PriorityUrgent  = 3  // ç´§æ€¥CTX
    PriorityHigh    = 2  // æ™®é€šCTX
    PriorityNormal  = 1  // åˆ†ç‰‡å†…äº¤æ˜“
    PriorityLow     = 0  // ä½ä¼˜å…ˆçº§äº¤æ˜“
)
```

### 3. æ‹å–æœºåˆ¶
- ç”¨æˆ·å¯è‡ªå®šä¹‰å‡ºä»·
- èŠ‚ç‚¹é€‰æ‹©å‡ºä»·æœ€é«˜çš„äº¤æ˜“
- å¸‚åœºåŒ–å®šä»·æœºåˆ¶

### 4. è·¨å…±è¯†æ”¯æŒ
- æ‰©å±•åˆ°Brokeræœºåˆ¶
- æ”¯æŒå…¶ä»–å…±è¯†ç®—æ³•
- ç»Ÿä¸€çš„ä¼˜å…ˆçº§æ¥å£

---

## å‚è€ƒæ–‡çŒ®

1. **Justitia: An Incentive Mechanism towards the Fairness of Cross-shard Transactions** (INFOCOM 2025)  
   [è®ºæ–‡é“¾æ¥](http://xintelligence.pro/archives/1371)

2. **Monoxide: Scale out Blockchains with Asynchronous Consensus Zones** (NSDI 2019)

3. **BrokerChain: A Cross-Shard Blockchain Protocol** (INFOCOM 2022)

4. **BlockEmulatoræŠ€æœ¯è®ºæ–‡** (IEEE TSC 2025)  
   [arXiv](https://arxiv.org/abs/2311.03612)

---

## é™„å½•

### A. å®Œæ•´é…ç½®ç¤ºä¾‹

```json
{
  "ConsensusMethod": 3,
  "PbftViewChangeTimeOut": 20000,
  "ExpDataRootDir": "expTest",
  
  "Block_Interval": 5000,
  "BlockSize": 2000,
  "BlocksizeInBytes": 200000,
  "UseBlocksizeInBytes": 0,
  
  "InjectSpeed": 2000,
  "TotalDataSize": 160000,
  "TxBatchSize": 16000,
  
  "BrokerNum": 10,
  "RelayWithMerkleProof": 0,
  "DatasetFile": "./selectedTxs_300K.csv",
  "ReconfigTimeGap": 50,
  
  "Delay": -1,
  "JitterRange": -1,
  "Bandwidth": 10000000,
  
  "EnableJustitia": 1,
  "JustitiaRewardBase": 100.0
}
```

### B. ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ | ç±»å‹ |
|----------|------|------|
| `core/transaction.go` | äº¤æ˜“ç»“æ„å®šä¹‰ | ä¿®æ”¹ |
| `core/txpool.go` | åŸå§‹äº¤æ˜“æ±  | ä¿ç•™ |
| `core/txpool_justitia.go` | ä¼˜å…ˆçº§äº¤æ˜“æ±  | æ–°å¢ âœ¨ |
| `params/global_config.go` | å…¨å±€é…ç½® | ä¿®æ”¹ |
| `paramsConfig.json` | é…ç½®æ–‡ä»¶ | ä¿®æ”¹ |
| `consensus_shard/pbft_all/pbftInside_module.go` | PBFTå…±è¯†é€»è¾‘ | ä¿®æ”¹ |
| `consensus_shard/pbft_all/pbftOutside_module.go` | Relayæ¶ˆæ¯å¤„ç† | ä¿®æ”¹ |
| `supervisor/measure/measure_Justitia.go` | åº¦é‡æ¨¡å— | æ–°å¢ âœ¨ |
| `justitia.md` | æœ¬æ–‡æ¡£ | æ–°å¢ âœ¨ |

### C. ä»£ç ç»Ÿè®¡

- **æ–°å¢æ–‡ä»¶**: 3ä¸ª
- **ä¿®æ”¹æ–‡ä»¶**: 5ä¸ª
- **æ–°å¢ä»£ç **: ~800è¡Œ
- **ä¿®æ”¹ä»£ç **: ~100è¡Œ
- **æ€»å·¥ä½œé‡**: ä¸­ç­‰

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- **HuangLab**: http://xintelligence.pro/
- **GitHub Issues**: https://github.com/HuangLab-SYSU/block-emulator/issues

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´  
**ä½œè€…**: BlockEmulatorå¼€å‘å›¢é˜Ÿ + AI Assistant

